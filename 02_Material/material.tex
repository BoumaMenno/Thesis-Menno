\documentclass[../DC2017114Bouma.tex]{subfiles}
\begin{document}
\graphicspath{{02_Material/img/}}
%% New chapter
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\renewcommand{\sectionmark}[1]{\markright{#1}{}}
\pagestyle{fancyreport}
\cleartooddpage
\pagestyle{fancyreport}
\chapter{Mechanical Systems with Unilateral Constraints and Spatial Friction}\label{ch:model}
In this chapter several modeling approaches of mechanical systems with unilateral constraints and spatial friction are presented. First a general representation of such a system is given, which is followed by sections introducing several formulations of the contact and friction laws in these systems. First a complementarity problem formulation is given, which is a complete and often used formulation for mechanical systems with unilateral constraints. From the complementarity formulation a hybrid system formulation is derived, which although less complete is a more intuitive formulation from a control point-of-view.
\section{General system definition}
For mechanical systems a set of contact points $i_c\in\{i_1,i_2,...,i_C\}$ is defined, with $C$ being the number of considered contact points. A set $\Ic_{\text{cl}}$ is defined as the set of $C_{\text{cl}}$ closed contact points, such that a contact $i_c\in\Ic_{\text{cl}}$ has closed a unilateral constraint. The set of contact points in open contact is defined as $\Ic_{\text{op}} := \{i_c\ |\ i_c\notin\Ic_{\text{cl}}\}$. When a unilateral constraint is activated at a nonzero velocity impact happens, meaning a jump in the velocity will appear. Therefore the generalized velocity $\dot{\qb}$ is not continuously defined over the entire domain of a trajectory with impacts. Therefore $\xib:=\dot{\qb}$ is defined, except at impact-times $\tau_i$. Here $i$ is a counter for unilateral constraint activations where $i\in \{1,2,...,N\}$, with $N$ the amount of jumps in a trajectory. $h_n$ is the normal contact distance and $\zeta_{n,i_c}$ and $\zetab_{t,i_c}$ represent the relative velocities in normal and tangential direction,  respectively. 

In Figure~\ref{fig:contactplanes} a body and a fixed world surface are illustrated. A contact point $i_c$ is defined on the body, on which a plane tangent to the surface of the body is spanned. On the normal direction of this plane, the contact distance $h_{n,i_c}(\qb)$ is defined. This is the distance between the contact point and the surface that it can make contact with. By taking the time derivative of $h_{n,i_c}(\qb)$, the relative normal velocity of contact point $i_c$ is found to be
\begin{align}
\zeta_{n,i_c} = \frac{\partial h_{n,i_c}}{\partial\qb}\frac{\text{d}\qb}{\text{d} t} = \wb_{n,i_c}^T\dot{\qb},
\end{align}
with $\wb_{n,i_c}^T$ representing the Jacobian of the normal velocity $\zeta_{n,i_c}$. The relative tangential velocity $\zetab_{t,i_c}$ is defined in the tangent plane of $i_c$, and thus lies perpendicular to $\zeta_{n,i_c}$. Using the tangential velocity jacobian $\Wb_{t,i_c}$, the relative tangential velocity is defined as
\begin{align}
\zetab_{t,i_c} = \Wb_{t,i_c}^T\dot{\qb}.
\end{align}

\begin{figure}[h]
\centering
\includegraphics[width=.6\textwidth]{contactplanes.eps}\caption{An illustration of a body impacting the fixed world. A contact point $i_c$ is defined on the body, which can make contact with the fixed world at $i_{FW}$. The points $i_c$ and $i_{FW}$ are connected by a line which is perpendicular to their respective bodies, which is used to define the contact distance $h_{n,i_c}$ and normal contact velocity $\zeta_{n,i_c}$. In the plane tangent to the body's surface, the tangential contact velocity $\zetab_{t,i_c}$ is defined.} \label{fig:contactplanes}
\end{figure}

Then, the continuous dynamics of a mechanical system with unilateral constraints and spatial friction are of the form
\begin{align}
&\Mb(\qb)\dot{\xib} + \Hb(\qb,\xib) = \Sb(\qb)\ub + \sum_{i_c\in\Ic_{\text{cl}}}\left(\wb_{n,i_c}(\qb)\lambda_{n,i_c} + \Wb_{t,i_c}(\qb)\lambdab_{t,i_c} \right), \label{eq:appcont1}\\
&\text{(Contact Law)},\label{eq:appcont2}\\
&\text{(Friction Law)},\label{eq:appcont3}
\end{align}
with $\qb,\xib\in\Rbb^{n}$ and $\ub\in\Rbb^m$. Here $\Mb(\qb)\in\Rbb^{n\times n}$ is the mass matrix of the system, $\Hb(\qb,\xib)\in\Rbb^{n}$ contains the centripetal, Coriolis and gravitational forces in the system and $\Sb(\qb)\in\Rbb^{n\times m}$ represents the generalized directions of the forces. $\lambda_{n,i_c}\in\Rbb$ and $\lambdab_{t,i_c}\in\Rbb^{2}$ are the normal and tangential reaction forces, respectively, of contact point $i_c$ with $\wb_{n,i_c}\in\Rbb^{n}$ and $\Wb_{t,i_c}\in\Rbb^{n\times 2}$ the corresponding reaction force jacobians. When a contact point activates a unilateral constraint, impulsive dynamics can cause the state of the system to jump. These dynamics are of the form

\begin{align}
&\Mb(\qb)(\xib^+ - \xib^-) = \sum_{i_c\in\Ic_{\text{cl}}}\left( \wb_{n,i_c}(\qb)\Lambda_{n,i_c} + \Wb_{t,i_c}(\qb)\Lambdab_{t,i_c}\right), \label{eq:appimp1}\\
&\text{(Impulsive Contact Law)},\label{eq:appimp2}\\
&\text{(Impulsive Friction Law)}.\label{eq:appimp3}
\end{align}
Here $\Lambda_{n,i_c}$ and $\Lambdab_{t,i_c}$ the normal and tangential impulsive reaction forces, respectively, of contact point $i_c$. These dynamics are impulsive, and happen at one instance in time. The $^-$ superscript indicates the ante-event state and the $^+$ superscript indicates the post-event state. In the following sections three different methods of describing the contact and friction laws are presented. First a complementarity problem formulation of mechanical systems with unilateral constraints is given, from which later a proximal point formulation and a hybrid system formulation are derived. For more information on modeling of multibody systems one can refer to \cite{Leine2008} and \cite{Wouw2016}. \textbf{Modes vs states}

\section{Complementarity problem formulation}\label{sec:comp}
\subsection{Signorini's contact law and Poisson's impact law}
To describe the normal contact between rigid bodies Signorini's contact law is used. Since the bodies are impenetrable and reaction forces caused by contact can not prevent the bodies from seperating, both the contact distance $h_{n,i_c}$ and $\lambda_{n,i_c}$ can not become negative. Two situations are possible

\begin{enumerate}
\item $h_{n,i_c}=0\ \wedge\ \lambda_{n,i_c} \geq 0$ (closed-contact)
\item $h_{n,i_c}>0\ \wedge\ \lambda_{n,i_c} = 0$ (open-contact)
\end{enumerate}

These situations are illustrated in Figure~\ref{fig:signorinicontact}, where it can be seen that the two situations are orthogonal. This behavior can be summarized in the complementarity condition

\begin{align}
0\leq h_{n,i_c}\ \bot\ \lambda_{n,i_c} \geq 0,\label{eq:signorini}
\end{align}

where the symbol $\bot$ is used to express the orthogonality between $h_{n,i_c}$ and $\lambda_{n,i_c}$. The complementarity condition in \eqref{eq:signorini} is called Signorini's contact law.
\begin{figure}[h]
\centering
\begin{subfigure}{0.3\textwidth}
\centering
\includegraphics[width=\linewidth]{signorinicontact.eps}
\caption{Signorini's contact law.}\label{fig:signorinicontact}
\end{subfigure}
\qquad
%\begin{subfigure}{0.3\textwidth}
%\centering
%\includegraphics[width=\linewidth]{signoriniforce.eps}
%\caption{Signorini's force law.}\label{fig:signoriniforce}
%\end{subfigure}
%\quad
\begin{subfigure}{0.3\textwidth}
\centering
\includegraphics[width=\linewidth]{poissonimpact.eps}
\caption{Poisson's impact law without restitution.}\label{fig:poissonimpact}
\end{subfigure}
\caption{}
\end{figure}

When contact happens at nonzero velocity, impact occurs. Newton's impact law is used to describe this impact. Newton's law of impact is defined as
\begin{align}
\zeta^+_{n,i_c} = -e_{n,i_c}\zeta^-_{n,i_c},\text{ when }h_{n,i_c}=0,\ \dot{h}_{n,i_c}<0.
\end{align}
In this work the coefficient of restitution $e_{n,i_c}$ is assumed to be $0$, describing a completely inelastic contact. For closed contact an impact law can be defined that relates the impulsive contact force $\Lambda_{n,i_c}$ to the post-impact normal velocity $\zeta_{n,i_c}$. When considering multi-contact systems, when a contact is closed two situations can occur:
\begin{enumerate}
\item $\Lambda_{n,i_c} > 0\ \wedge\ \zeta^+_{n,i_c} = 0$ (impact)
\item $\Lambda_{n,i_c} = 0\ \wedge\ \zeta^+_{n,i_c} \geq 0$ (no impact)
\end{enumerate}
The second case can occur when a contact point other than $i_c$ makes impact. The situations described above are illustrated in Figure~\ref{fig:poissonimpact}, where again the orthogonality can be observed. The behavior is written into the complementarity condition

\begin{align}
0\leq \zeta^+_{n,i_c}\ \bot\ \Lambda_{n,i_c} \geq 0,\quad  \qquad \forall i_c\in\Ic_{\text{cl}},\label{eq:poisson}
\end{align}

with $\Ic_{\text{cl}}$ the set of closed contacts. The complementarity condition \eqref{eq:poisson} is called Poisson's impact law. Note that the impact law is defined on velocity level, whereas the contact law is defined on position level.
\subsection{Coulomb's friction law}
Coulomb's friction law is often used to describe dry friction in mechanical systems. When considering 3-dimensional environments, Coulomb's friction law is defined as 

\begin{align}
||\lambdab_{t,i_c}||\ \in\ \left\{ \begin{array}{ll}
||\lambdab_{t,i_c}||\leq\mu\lambda_{n,i_c}, &\text{if }||\zetab_{t,i_c}||=0\\
||\lambdab_{t,i_c}|| = \mu\lambda_{n,i_c}, &\text{if }||\zetab_{t,i_c}||>0
\end{array}\right.,\label{eq:frictionlen}
\end{align}
and since friction is considered isotropic
\begin{align}
\zetab_{t,i_c} = -\kappa_{i_c}\SgnSp(\lambdab_{t,i_c}),\label{eq:frictiondir}
\end{align}
with $\kappa_{i_c}>0$ and
\begin{equation}
\SgnSp(a) = \left\lbrace\begin{array}{ll}
\frac{a}{||a||} & a \neq 0\\
0 & a = 0
\end{array},\right.
\end{equation}

for a vector $a$ as defined in \cite{Studer2006}.

\eqref{eq:frictionlen} can be considered as a relation between the magnitude of the tangential velocity $\zetab_{t,i_c}$ and the reaction friction force $\lambdab_{t,i_c}$. \eqref{eq:frictiondir} can be considered as a relation between the direction of $\zetab_{t,i_c}$ and $\lambdab_{t,i_c}$, namely that $\zetab_{t,i_c}$ and $\lambdab_{t,i_c}$ are always in opposite directions. The constant $\kappa_{i_c}$ can then be interpreted as the magnitude of the tangential velocity. Coulomb's friction law is illustrated in Figure~\ref{fig:coulombfriction}. In Figure~\ref{fig:coulombort} the same law is illustrated, but now as orthogonal vectors. As noticed earlier, this is convenient for writing the law in a complementarity form.

\begin{figure}[h]
\centering
\begin{subfigure}{0.38\textwidth}
\centering
\includegraphics[width=\linewidth]{coulombfriction.eps}\caption{Coulomb's friction law.}\vspace{1.25cm}\label{fig:coulombfriction}
\end{subfigure}
\qquad
\begin{subfigure}{0.3\textwidth}
\centering
\includegraphics[width=\linewidth]{coulombort.eps}\caption{Coulomb's friction law as orthogonal vectors. $\kappa_{i_c}$ is defined as the magnitude of the tangential velocity $\zetab_{t,i_c}$.}\label{fig:coulombort}
\end{subfigure}
\end{figure}

The complementarity formulation of the Coulomb's law is therefore defined as

\begin{align}
&0\leq \left(\mu\lambda_{n,i_c} - ||\lambdab_{t,i_c}||\right)\ \bot\ \kappa_{i_c} \geq 0,\label{eq:coulomb1}\\
&\zetab_{t,i_c} = -\kappa_{i_c}\SgnSp(\lambdab_{t,i_c}).\label{eq:coulomb2}
\end{align}

\eqref{eq:frictiondir} is rewritten to \eqref{eq:coulomb2} to avoid singularity problems for $||\lambdab_{t,i_c}|| = 0$. For the impulsive behavior of the friction law Newton's impact law is used to define the tangential post-impact velocity as
\begin{align}
\zetab^+_{t,i_c} = -e_{t,i_c}\zetab^-_{t,i_c},
\end{align}
where in this work $e_{t,i_c}=0$ is assumed. Then, similarly to the non-impulsive case, the impulsive Coulomb's friction law can be defined as
\begin{align}
&0 \leq (\mu\Lambda_{n,i_c} - ||\Lambdab_{t,i_c}||)\ \bot\ \kappa_{i_c} \geq 0. \qquad \forall i_c\in\Ic_{\text{cl}},\label{eq:coulombimp1}\\
&\zetab_{t,i_c}^+ = \kappa_{i_c}\SgnSp(\Lambdab_{t,i_c}),\qquad \forall i_c\in\Ic_{\text{cl}}.\label{eq:coulombimp2}
\end{align}
Note that just as the contact case, the impulsive friction law only holds for closed contacts.
\subsection{System dynamics with contact and friction law}
The flow dynamics are then described by
\begin{align}
&\Mb(\qb)\dot{\xib} + \Hb(\qb,\xib) = \Sb(\qb)\ub + \sum_{i_c\in\Ic_{\text{cl}}}\left(\wb_{n,i_c}(\qb)\lambda_{n,i_c} + \Wb_{t,i_c}(\qb)\lambdab_{t,i_c} \right), \label{eq:ncpcontact1}\\
&0\leq h_{n,i_c}\ \bot\ \lambda_{n,i_c} \geq 0,\label{eq:ncpcontact2}\\
&0\leq \left(\mu\lambda_{n,i_c} - ||\lambdab_{t,i_c}||\right)\ \bot\ \kappa_{i_c} \geq 0,\label{eq:ncpcontact3}\\
&\zetab_{t,i_c} = -\kappa_{i_c}\SgnSp(\lambdab_{t,i_c}),\label{eq:ncpcontact4}
\end{align}
with 
\begin{align}
&h_{n,i_c} = \wb_{n,i_c}^T(\qb)\qb,\label{eq:h}\\
&\zeta_{n,i_c}(\qb) = \wb^T_{n,i_c}(\qb) \xib,  \label{eq:zetan}\\
&\zetab_{t,i_c}(\qb) = \Wb^T_{t,i_c}(\qb) \xib. \label{eq:zetab}
\end{align}
The discrete dynamics, which take place when a contact point goes through an event, are described by
\begin{align}
&\Mb(\qb)(\xib^+ - \xib^-) = \sum_{i_c\in\Ic_{\text{cl}}}\left( \wb_{n,i_c}(\qb)\Lambda_{n,i_c} + \Wb_{t,i_c}(\qb)\Lambdab_{t,i_c}\right), \label{eq:ncpimpact1}\\
&0\leq \zeta_{n,i_c}^+\ \bot\ \Lambda_{n,i_c} \geq 0, \qquad \forall i_c\in\Ic_{\text{cl}},\label{eq:ncpimpact2}\\
&0 \leq (\mu\Lambda_{n,i_c} - ||\Lambdab_{t,i_c}||)\ \bot\ \kappa_{i_c} \geq 0. \qquad \forall i_c\in\Ic_{\text{cl}},\label{eq:ncpimpact3}\\
&\zetab_{t,i_c}^+ = -\kappa_i\SgnSp(\Lambdab_{t,i_c}),\qquad \forall i_c\in\Ic_{\text{cl}},\label{eq:ncpimpact4}
\end{align}
with 
\begin{align}
&\zeta^+_{n,i_c}(\qb) = \wb^T_{n,i_c}(\qb) \xib^+,\\
&\zetab^+_{t,i_c}(\qb) = \Wb^T_{t,i_c}(\qb) \xib^+.\label{eq:ncpimpactend}
\end{align}

\section{Hybrid system formulation}
In this section the dynamics of the complementarity system defined in Section~\ref{sec:comp} is written to a hybrid formulation, resulting in a hybrid framework for mechanical systems with unilateral constraints and spatial friction. The hybrid system formulation only holds for trajectories where only the contact points activating a guard function are allowed to change mode, i.e. no superfluous contacts. More information on the considered trajectories in this work is given in Section~\ref{app:trajectories}.

\subsection{Hybrid systems with impulsive effects}\label{sec:2hyb}
According to \cite{Haddad2006} an impulsive dynamical system can be described by a hybrid system with impulsive effects. This makes it a valid framework for mechanical systems with unilateral constraints and spatial friction. The notation given in \cite{Haddad2006} is convenient from a tracking point-of-view, in that only the dynamics encountered during the trajectory need to be described. A hybrid system with impulsive effects consists of three elements:
\begin{enumerate}
\item Continuous dynamics, a continuous-time differential equation which defines the behavior of the system in between events
\item Discrete dynamics, which defines the way the state of the system is reset during events
\item Reset sets, which is a criterion to decide when the state of the system is to be reset
\end{enumerate}

Therefore, a hybrid system with impulsive effects is given by
\begin{equation}
\begin{array}{ll}
\dot{\xb}(t,i) =\fb_i(\xb(t,i),\ub(t,i),t),& \xb(t,i),\ub(t,i)\notin D_i\\
\xb(t,i) = \gb_i(\xb(t,i-1),\ub(t,i-1),t),& \xb(t,i-1),\ub(t,i-1)\in D_i
\end{array}\label{eq:hybimp}
\end{equation}
with $\xb(t,i)\in\Rbb^{n(i)}$, $\ub(t,i)\in\Rbb^{m(i)}$, $\fb_i(t,i)\ :\ \Rbb^{n(i)}\ \times\ \Rbb^{m(i)}\ \times\ \Rbb\rightarrow \Rbb^{n(i)}$. Note that the state dimension $n(i)$ and the input dimension $m(i)$ can vary in different modes $i$. For the difference equation we have $\gb_i\ :\ \Rbb^{n(i-1)}\ \times\ \Rbb^{m(i-1)}\ \times\ \Rbb\rightarrow \Rbb^{n(i)}$. The set $D_i = D_i(t) := \{\xb(t,i)\in\Rbb^{n(i)},\ \ub(t,i)\in\Rbb^{m(i)}\ |\ \gamma^{=}_i(\xb^{\wedge},\ub^{\wedge},t) = 0, \ \gamma^{\geq}_i(\xb^{\wedge},\ub^{\wedge},t) \geq 0\}$, where $\gamma^{=}_i$ and $\gamma^{\geq}_i$ are some sets of guard functions that are activated at event $i$, and $\xb^{\wedge}$,$\ub^{\wedge}$ are some virtual state and input that are not necessarily physically realistic.

The dynamics given in \eqref{eq:hybimp} will be used to describe a tracking problem for mechanical systems with unilateral constraints and spatial friction. A nominal state-input trajectory is considered consisting of absolutely continuous segments $(\alphab(t,i),\mub(t,i))$, with $t\in\left[\tau_i,\tau_{i+1}\right]$ and $i\in\{0,1,...,N\}$ the event counter. $\alphab(t,i)$ and $\mub(t,i)$ are the nominal state and input, respectively, that define the nominal trajectory with $N$ events. $\tau_i$ is referred to as the nominal event time of event $i$ and $t$ is referred to as regular time. Every segment of the nominal trajectory $(\alphab(t,i),\mub(t,i))$ and every event $i\in\{0,1,...,N\}$ satisfy the dynamics in \eqref{eq:hybimp}, where an event happens when $(\alphab(t,i),\mub(t,i))$ enters $D_{i+1}$. Such a nominal trajectory existing of absolutely continuous segments experiencing events according to \eqref{eq:hybimp} is illustrated in Figure~\ref{fig:2exampletraj}.

In \ref{fig:2example} an example trajectory of a block pushing towards a surface is illustrated. The block has two contact points on its edges $i_1$ and $i_2$. It starts with both contact points in open contact as can be seen in Figure~\ref{fig:2example1}. The flow is described by $\dot{\alphab}(t,0) = \fb_0(\alphab(t,0),\mub(t,0),t)$ for $t\in[t_0,\tau_1]$. Then $i_2$ makes impact with the surface at $\tau_1$, causing a jump in the state and a change in continuous dynamics $\dot{\alphab}(t,1) = \fb_1(\alphab(t,1),\mub(t,1),t)$ for $t\in[\tau_1,\tau_2]$. This is illustrated in Figure~\ref{fig:2example2}, where $i_2$ is in closed contact and slipping over the contact surface. At $\tau_2$, $i_1$ makes impact as well causing another jump and another change in continuous dynamics. The block now has both contact points slipping over the contact surface. After this both contact points release contact one by one. Since there are no impulsive forces present in this transition, the state does not jump when a contact point releases. However, a jump in the time-derivate of the state is possible, which makes these transitions continuous but nonsmooth.

\begin{figure}[h]
\centering
\begin{subfigure}[b]{0.17\textwidth}
\centering
\includegraphics[width=\textwidth]{example1.eps}
\caption{$i_1,i_2\in\Ic_{\text{op}}$}
\label{fig:2example1}
\end{subfigure}
\quad
\begin{subfigure}[b]{0.17\textwidth}  
\centering 
\includegraphics[width=\textwidth]{example2.eps}
\caption{$i_2\in\Ic_{\text{sl}}$}
\label{fig:2example2}
\end{subfigure}
\quad
\begin{subfigure}[b]{0.17\textwidth}   
\centering 
\includegraphics[width=\textwidth]{example3.eps}
\caption{$i_1,i_2\in\Ic_{\text{sl}}$}
\label{fig:2example3}
\end{subfigure}
\quad
\begin{subfigure}[b]{0.17\textwidth}  
\centering 
\includegraphics[width=\textwidth]{example4.eps}
\caption{$i_1\in\Ic_{\text{sl}}$}
\label{fig:2example4}
\end{subfigure}
\quad
\begin{subfigure}[b]{0.17\textwidth}   
\centering 
\includegraphics[width=\textwidth]{example5.eps}
\caption{$i_1,i_2\in\Ic_{\text{op}}$}
\label{fig:2example5}
\end{subfigure}
\vskip\baselineskip
\begin{subfigure}[b]{\textwidth}   
\centering 
\includegraphics[width=.85\textwidth]{exampletraj1.eps}
\caption{The state-trajectory of a block pushing towards a surface, then sliding across that surface and finally releasing from the surface.}
\label{fig:2exampletraj}
\end{subfigure}
\caption{An example trajectory, which satisfies the dynamics \eqref{eq:hybimp}, of a block pushing towards and withdrawing from a surface with velocity $v$.  Note that the sets $D$ besides being dependent on $\xb$, are also dependent on $\ub$. Also, although not depicted in this image, the state space of the system varies with every event.}
\label{fig:2example}
\end{figure}

The following sections will be used to write the complementarity system defined in Section~\ref{sec:comp} into a hybrid system with impulsive effects as in \eqref{eq:hybimp}. In \ref{sec:2contdyn} the continuous dynamics $\fb_i$ will be derived for mechanical systems with unilateral constraints and spatial friction. Then, in Section~\ref{sec:2event} the reset set $D_i$ will be defined. Finally, in Section~\ref{sec:2discdyn} the discrete dynamics $\gb_i$ will be derived. This will fully define the hybrid system with impulsive effects formulation of mechanical systems with unilateral constraints and spatial friction.

\subsection{Continuous dynamics}\label{sec:2contdyn}
When describing mechanical systems, we take 

\begin{align}
\xb = \begin{bmatrix}
\qb\\ \dot{\qb}
\end{bmatrix},\quad
\dot{\xb} = \begin{bmatrix}
\dot{\qb}\\ \ddot{\qb}
\end{bmatrix},
\end{align}

where $\qb$ and $\dot{\qb}$ are the joint positions, velocities and accelerations respectively. As described in Section~\ref{sec:comp}, for mechanical systems a set of contact points $i_c\in\{i_1,i_2,...,i_C\}$ is defined. Here $C$ is the number of considered contact points. A set $\Ic_{\text{cl}}$ is defined as the set of closed contact points, such that a contact $i\in\Ic_{\text{cl}}$ has closed a unilateral constraint. The set of contact points in open contact is defined as $\Ic_{\text{op}} := \{i_c\ |\ i_c\notin\Ic_{\text{cl}}\}$. The set $\Ic_{\text{cl}}$ is subdivided in two subsets $\Ic_{\text{sl}}$ and $\Ic_{\text{st}}$, where $\Ic_{\text{sl}}$ is the set of closed contact points in slip and $\Ic_{\text{st}}$ the set of closed contact points in stick. Here $\Ic_{\text{cl}} =\Ic_{\text{sl}}\cup\Ic_{\text{st}}$ and $\Ic_{\text{sl}}\cup\Ic_{\text{st}}=\emptyset$. 

The equations of motion, given in \eqref{eq:appcont1}, can be rewritten to
\begin{align}
\ddot{\qb} = \Mb^{-1}(\qb)\left[ \Sb(\qb)\ub - \Hb(\qb,\dot{\qb}) + \Wb_{n}(\qb)\lambdab_{n} + \Wb_{t}(\qb)\lambdab_{t}\right],\label{eq:qddot}
\end{align}
with
\begin{align}
\Wb_n &= \begin{bmatrix}
\wb_{n,i_1},\wb_{n,i_2},...,\wb_{n,i_c}
\end{bmatrix}\in\Rbb^{n\times C},\\
\Wb_t &= \begin{bmatrix}
\Wb_{t,i_1},\Wb_{t,i_2},...,\Wb_{t,i_c} 
\end{bmatrix}\in\Rbb^{n\times 2C},\\
\lambdab_n &= \begin{bmatrix}
\lambda_{n,i_1};\lambda_{n,i_2};...;\lambda_{n,i_C} 
\end{bmatrix}\in\Rbb^{C},\\
\lambdab_t &= \begin{bmatrix}
\lambdab_{t,i_1};\lambdab_{t,i_2};...;\lambdab_{t,i_C} 
\end{bmatrix}\in\Rbb^{2C},
\end{align}
Note that since $\fb_i$ is only defined on $\xb(t,i),\ub(t,i)\notin D_i$, it is not necessary to use $\xib$ to define the equations of motion as done in \eqref{eq:appcont1}. Now $\fb_i$ can be written as
\begin{align}
\dot{\xb}(t,i) =\begin{bmatrix}
\dot{\qb}\\ \Mb^{-1}(\qb)\left[ \Sb(\qb)\ub - \Hb(\qb,\dot{\qb}) + \Wb_{n}(\qb)\lambdab_{n} + \Wb_{t}(\qb)\lambdab_{t}\right]
\end{bmatrix}.\label{eq:fcont}
\end{align}
The closed contact points in $\Ic_{\text{cl}}$ experience reaction forces $\lambda_{n,i_c}$ and $\lambdab_{t,i_c}$, as can be seen in \eqref{eq:qddot}. Therefore for all closed contact points $i_c\in\Ic_{\text{cl}}$ constraints are given which define these reaction forces. These constraints are given by
\begin{equation}
\begin{array}{ll}
\wb^T_{n,i_c}(\qb)\ddot{\qb} + \dot{\wb}^T_{n,i_c}(\qb)\dot{\qb} = 0, & \forall i_c\in\Ic_{\text{cl}},\\
\lambdab_{t,i_c} + \mu\lambda_{n,i_c}\SgnSp(\Wb_{t,i_c}^T\dot{\qb}) = 0, & \forall i_c\in\Ic_{\text{sl}},\\
\Wb^T_{t,i_c}(\qb)\ddot{\qb} + \dot{\Wb}^T_{t,i_c}(\qb)\dot{\qb} = 0, & \forall i_c\in\Ic_{\text{st}},
\end{array}\label{eq:fcontconst}
\end{equation}
where $\Ic_{\text{sl}}$ and $\Ic_{\text{st}}$ are the sets of closed contacts in slip and closed contacts in stick respectively. Now, with \eqref{eq:fcont} and \eqref{eq:fcontconst}, the continuous dynamics of the hybrid system with impulsive dynamics are correctly defined. A more thorough derivation of these dynamics can be found in Appendix~\ref{app:hybrid}.

\subsection{Discrete event sets}\label{sec:2event}
When the continuous dynamics enter an event set $D$, an event will take place. Such an event can cause a contact point to enter a different set. This will lead to different post-event continuous dynamics, and it can cause the state to reinitialize according to the discrete dynamics presented in Section~\ref{sec:2discdyn}. For each set of contact points these sets are defined differently. In this section the sets $D$ are defined for each set of contact points. The derivation of the discrete event sets can be found in Appendix~\ref{app:hybrid}.

\textbf{Maybe organize by impulsive vs non-impulsive}

\textbf{Discrete events sets in open contact} $D_{\text{op}\rightarrow}$\\
For all contact points $i_c\in\Ic_{\text{op}}$ the discrete event sets are defined as
\begin{align}
D_{\text{op}\rightarrow\text{sl}} &= \{ \qb\ |\ \gamma_{\text{op}\rightarrow\text{cl}} = 0,\ \dot{\gamma}_{\text{op}\rightarrow\text{cl}} < 0 \},\\
D_{\text{op}\rightarrow\text{st}} &= \{ \qb\ |\ \gamma_{\text{op}\rightarrow\text{cl}} = 0,\ \dot{\gamma}_{\text{op}\rightarrow\text{cl}} < 0 \},
\end{align}
with
\begin{align}
\gamma_{\text{op}\rightarrow\text{cl}} &= h_{n,i_c}(\qb),
\end{align}

\textbf{Discrete events sets in closed contact slip} $D_{\text{sl}\rightarrow}$\\
For all contact points $i_c\in\Ic_{\text{sl}}$ the discrete event sets are defined as
\begin{align}
D_{\text{sl}\rightarrow\text{st}} &= \{ \qb\ |\ \gamma_{\text{sl}\rightarrow\text{st}} = 0,\ \dot{\gamma}_{\text{sl}\rightarrow\text{st}} < 0\}\\
D_{\text{sl}\rightarrow\text{op}} &= \{ \qb,\ub\ |\ \gamma_{\text{cl}\rightarrow\text{op}} = 0,\ \dot{\gamma}_{\text{cl}\rightarrow\text{op}} < 0\},
\end{align}
with 
\begin{align}
\gamma_{\text{sl}\rightarrow\text{st}} &= \zetab_{t,i_c}\zetab_{t,i_c}^T\\
\gamma_{\text{cl}\rightarrow\text{op}} &= \lambda_{n,i_c}.
\end{align}

\textbf{Discrete events sets in closed contact stick} $D_{\text{st}\rightarrow}$\\
For all contact points $i_c\in\Ic_{\text{st}}$ the discrete event sets are defined as
\begin{align}
D_{\text{st}\rightarrow\text{sl}} &= \{ \qb,\ub\ |\ \gamma_{\text{st}\rightarrow\text{sl}} = 0,\ \dot{\gamma}_{\text{sl}\rightarrow\text{st}} < 0\}\\
D_{\text{st}\rightarrow\text{op}} &= \{ \qb,\ub\ |\ \gamma_{\text{cl}\rightarrow\text{op}} = 0,\ \dot{\gamma}_{\text{cl}\rightarrow\text{op}} < 0\},
\end{align}
with 
\begin{align}
\gamma_{\text{st}\rightarrow\text{sl}} &= \mu^2\lambda_{n,i_c}^2-\lambdab_{t,i_c}\lambdab_{t,i_c}^T\\
\gamma_{\text{cl}\rightarrow\text{op}} &= \lambda_{n,i_c}.
\end{align}

\subsection{Discrete dynamics}\label{sec:2discdyn}
When a contact point enters a discrete event set $D$, the system goes through an event. Since the state can be reinitialized during such an event, the event can cause other contact points to enter another mode as well. The reinitialization of the state and selection of a post-event mode is described by the discrete dynamics in this section. The reinitialization of te state is defined by a jump map $\gb$. Since it is unknown before an event what the post-event mode is, all possible modes should be iterated over until a feasible post-event mode is found. In essence, this feasible post-event mode can be found by solving the NCP defined in Section~\ref{sec:comp}. This NCP generates a unique feasible solution \cite{Delassus1917}, which for simple systems can be found by iterating over all solutions until the feasible solution is found.

During a transition described by \eqref{eq:3discdyn1}-\eqref{eq:3discdyn4} the ante-impact position will always be equal to the post-impact position. The ante and post-event velocity can differ however. When $\dot{\qb}^+\neq\dot{\qb}^-$ one speaks of an impulsive discontinuity, and when $\dot{\qb}^+=\dot{\qb}^-$ one speaks of a Filippov-discontinuity. In the case of mechanical systems, a contact point making contact with a surface at non-zero velocity will result in an impulsive discontinuity. Other events (releasing and stick-slip transitions) will result in a Filippov-discontinuity. No impulsive forces are present at a Filippov-discontinuity, which is confirmed by \eqref{eq:3discdyn1} when $\dot{\qb}^+=\dot{\qb}^-$. One could also say that an impulsive discontinuity is defined on velocity level, and a Filippov-discontinuity is defined on acceleration level. Why the distinction between these two events is important will become clear during the "mode selection" part of the discrete dynamics, which is described in the next paragraph. \textbf{Should I prove that some events are impulsive and others Filippov, or can I claim this based on intuition?}

\textbf{Impulsive events}\\
From the impulsive dynamics \eqref{eq:ncpimpact1}-\eqref{eq:ncpimpact4}, the discrete dynamics of a transition can be derived as
\begin{align}
&\dot{\qb}^+ = \Mb^{-1}\left[\Wb_{n}\Lambdab_{n} + \Wb_{t}\Lambdab_{t}\right] + \dot{\qb}^-, \label{eq:3discdyn1}\\
&\wb^T_{n,i_c}\dot{\qb}^+ = 0, &\forall i_c\in\Ic_{\text{cl}},\label{eq:3discdyn2}\\
&\Lambdab_{t,i_c} = -\mu\Lambda_{n,i_c}\SgnSp(\zetab^-_{t,i_c}), &\forall i_c\in\Ic_{\text{sl}},\label{eq:3discdyn3}\\
&\Wb^T_{t,i_c}\dot{\qb}^+ = 0, &\forall i_c\in\Ic_{\text{st}},\label{eq:3discdyn4}
\end{align}

Here the unknown variables are $\dot{\qb}^+\in\Rbb^{n}$, $\Lambdab_{n}\in\Rbb^{C_{\text{cl}}}$ and $\Lambdab_{t}\in\Rbb^{2C_{\text{cl}}}$, which means that there are $n+3C_{\text{cl}}$ unknown variables. From \eqref{eq:3discdyn1} we get $n$ equations, from \eqref{eq:3discdyn2} we get $C_{\text{cl}}$ equations and since $\Ic_{\text{sl}}\cup\Ic_{\text{st}}=\Ic_{\text{cl}}$ and $\Lambdab_{t,i_c},\ \Wb^T_{t,i_c}\dot{\qb}^+\in\Rbb^2$ we get $2C_{\text{cl}}$ equations from \eqref{eq:3discdyn3}-\eqref{eq:3discdyn4}. Since we have $n+3C_{\text{cl}}$ unknown variables and $n+3C_{\text{cl}}$ equations, the system is solvable. 

\textbf{Non-impulsive events}\\




\textbf{Mode selection}\\
The problem that remains is that it is not straightforward to know what system to solve. The system that should be solved to find the post-impact state is determined by the post-impact mode. When a contact point enters a discrete event set, and thus generates an infeasible state, it can be concluded that the system will go through an event because in it's current mode the system is infeasible. However, it is not guaranteed that the contact point which entered the event set will change mode. Actually any contact point, or even several contact points, can change in mode. As can be seen in \eqref{eq:3discdyn2}-\eqref{eq:3discdyn4} the constraints on the discrete dynamics change when the contact points vary in their post-impact mode.  To find the correct mode, the discrete dynamics \eqref{eq:3discdyn1}-\eqref{eq:3discdyn4} should be solved for several modes until a feasible post-impact state is found. Since there are $C$ contact points $C^3$ different modes are possible, which means that at most the discrete dynamics should be solved $C^3$ times before the feasible post-impact state is found. A feasible post-impact state is a post-impact state solved for a certain set of $i_c$, such that the all corresponding guard functions are larger than 0. \textbf{$\leftarrow$ EXPLAIN MORE} As mentioned earlier, there will exist a unique post-impact mode where the system has a feasible post-impact state. This process used for mode selection is called the \textit{sweeping process} \cite[p. 117]{Brogliato1996}. 

During this process it is important to realize at which level the guard functions are defined. A distinction can be made between guards defined at position level, guards defined at velocity level and guards defined at acceleration level. A guard function defined on position level does not change value when different discrete dynamics are solved. As can be seen in \eqref{eq:3discdyn1}, only the velocity is reinitialized during an event. This means that when an event is triggered, the event can not cause contact points to change mode based on a position-level guard function. An example of a position-level guard function is $\gamma_{\text{op}\rightarrow\text{cl}}$. When an event happens, a contact point cannot transition from open to closed as the position of the contact point is not updated through the discrete dynamics. For a guard-activation on velocity level a jump map on velocity level can cause the guard function to change value. Therefore, during an impulsive event all contact points can change mode based on velocity level guard functions. The same holds for acceleration level guard functions during an impulsive event. All velocity and acceleration level guard functions should be swept over. For a non-impulsive event, only the acceleration changes value. Therefore only acceleration level guard functions should be swept over during a non-impulsive event. This is summarized in Table~\ref{tab:sweeping}.

\begin{table}[h]
\caption{Summary of at what levels should be swept during impulsive and non-impulsive events.}\label{tab:sweeping}
\begin{tabular}{l|ccc}
\textbf{Event} & \textbf{Position Sweeping} & \textbf{Velocity Sweeping} & \textbf{Acceleration Sweeping} \\ \hline
Impulsive      &                            & $\boldsymbol{\times}$                   & $\boldsymbol{\times}$                       \\
Non-impulsive  &                            &                            & $\boldsymbol{\times}$                      
\end{tabular}
\end{table}

Since only contact points closing contact can generate impulsive forces, impulsive events only happen when $\gamma_{\text{op}\rightarrow\text{cl}}$ is activated. This is convenient, because $\gamma_{\text{op}\rightarrow\text{cl}}$ is defined on position level. Therefore sweeping has no effect on whether an event is impulsive or not, and one knows based on the activated guard function over which guard functions should be swept. As can be seen in Table~\ref{tab:sweeping}, when $\gamma_{\text{op}\rightarrow\text{cl}}$ is activated (impulsive event) sweeping should be done on velocity and acceleration level. When other guard functions are activated (non-impulsive) sweeping should be done only on acceleration level.

The sweeping process is now demonstrated with an example. Let's consider the segments $\alphab(t,0)$ and $\alphab(t,1)$ from Figure~\ref{fig:2exampletraj}. The system enters event set $D_1$ by activating $\gamma_{\text{op}\rightarrow\text{cl}}$, which indicates an infeasible state and that an impulsive event is triggered. One should therefore sweep over all possible velocity and acceleration guards. For contact point $i_1$ only a position level guard can be activated, from which can be concluded that this contact point will stay in the same mode. The contact point that is going through an open to closed transition

\textbf{Image of event $\rightarrow$ event and where sweeping should be used}

\section{Summary}

\end{document}